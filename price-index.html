<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Ranger Pricing Index</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Header */
        .rr-header {
            background: linear-gradient(135deg, #14213d 0%, #1e3a8a 100%);
            color: #fff;
            padding: 0;
            margin: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .rr-header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 80px;
            max-width: 100vw;
            padding: 0 32px;
        }

        .rr-title {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
            font-size: 13px;
        }

        .last-updated {
            font-weight: 500;
            opacity: 0.9;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
            overflow: hidden;
        }

        /* Store List Sidebar */
        .store-list {
            width: 300px;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        /* Alert Section */
        .alert-section {
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border-bottom: 2px solid #e0e0e0;
        }

        .alert-header {
            background: #dc2626;
            color: white;
            padding: 12px 16px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: background 0.3s ease;
        }

        .alert-header:hover {
            background: #b91c1c;
        }

        .alert-header.no-alerts {
            background: #16a34a;
            color: white;
        }

        .alert-header.no-alerts:hover {
            background: #15803d;
            color: white;
        }

        .alert-toggle {
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .alert-toggle.collapsed {
            transform: rotate(90deg);
        }

        .alert-count {
            background: white;
            color: #dc2626;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 8px;
            transition: color 0.3s ease;
        }

        .alert-header.no-alerts .alert-count {
            color: #16a34a;
        }

        .alert-content {
            max-height: 300px;
            overflow-y: auto;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .alert-content.collapsed {
            max-height: 0;
        }



        .alert-list {
            padding: 0;
        }

        .alert-store-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #fee2e2;
            background: white;
            transition: all 0.15s ease;
        }

        .alert-store-item:hover {
            background: #fef2f2;
        }

        .alert-store-item.active {
            background: #fee2e2;
            border-left: 4px solid #dc2626;
        }

        .alert-store-number {
            font-size: 14px;
            font-weight: 700;
            color: #991b1b;
            margin-bottom: 2px;
        }

        .alert-store-reason {
            font-size: 10px;
            color: #dc2626;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .alert-store-city {
            font-size: 10px;
            color: #6b7280;
        }

        .no-alerts {
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 12px;
        }

        .no-alerts-icon {
            font-size: 32px;
            margin-bottom: 8px;
            color: #16a34a;
        }

        /* Store List Section */
        .store-list-section {
            flex: 1;
            overflow-y: auto;
        }

        .store-item.hidden {
            display: none;
        }

        .store-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .store-item:hover {
            background: #f8f9fa;
        }

        .store-item.active {
            background: #e3f2fd;
            border-left: 4px solid #1e3a8a;
            font-weight: 600;
            color: #1e3a8a;
        }

        .store-number {
            font-size: 15px;
            font-weight: 600;
            color: #1e3a8a;
        }

        .store-item.active .store-number {
            color: #14213d;
        }

        .store-name {
            font-size: 11px;
            color: #666;
            margin-top: 1px;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 32px 40px;
            background: #f5f7fa;
        }

        .welcome-message {
            text-align: center;
            padding: 120px 40px;
            color: #999;
        }

        .welcome-message h2 {
            font-size: 28px;
            margin-bottom: 12px;
            color: #666;
        }

        .welcome-message p {
            font-size: 16px;
        }

        /* Store Details */
        .store-details {
            max-width: 1600px;
            margin: 0 auto;
        }

        .store-header {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .store-header-left h2 {
            font-size: 32px;
            color: #14213d;
            margin-bottom: 8px;
        }

        .store-location {
            font-size: 16px;
            color: #666;
        }

        .store-header-right {
            text-align: right;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #666;
        }

        .action-btn:hover {
            border-color: #1e3a8a;
            color: #1e3a8a;
            background: #f8f9fa;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .summary-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .summary-card.competitive {
            border-left-color: #16a34a;
        }

        .summary-card.expensive {
            border-left-color: #dc2626;
        }

        .summary-card.neutral {
            border-left-color: #f59e0b;
        }

        .summary-label {
            font-size: 13px;
            color: #666;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: #14213d;
        }

        .summary-value.positive {
            color: #16a34a;
        }

        .summary-value.negative {
            color: #dc2626;
        }

        .summary-detail {
            font-size: 13px;
            color: #888;
            margin-top: 6px;
        }

        /* Competitor Filter */
        .competitor-filter-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .filter-header {
            background: #f8f9fa;
            color: #333;
            padding: 14px 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-bottom: 1px solid #e0e0e0;
        }

        .filter-header:hover {
            background: #f1f3f5;
        }

        .filter-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .filter-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .filter-content {
            max-height: 400px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .filter-content.collapsed {
            max-height: 0;
        }

        .filter-body {
            padding: 20px 24px;
        }

        .filter-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e9ecef;
        }

        .filter-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .filter-btn:hover {
            background: #5a6268;
        }

        .filter-search {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-search:focus {
            outline: none;
            border-color: #1e3a8a;
        }

        .competitor-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .competitor-checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s ease;
        }

        .competitor-checkbox-item:hover {
            background: #f8f9fa;
        }

        .competitor-checkbox-item:last-child {
            border-bottom: none;
        }

        .competitor-checkbox-item.hidden {
            display: none;
        }

        .competitor-checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            cursor: pointer;
        }

        .competitor-checkbox-label {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            font-size: 14px;
        }

        .competitor-checkbox-name {
            color: #333;
        }

        .competitor-checkbox-distance {
            color: #6c757d;
            font-size: 12px;
            font-weight: 500;
        }

        /* Price Trends Section */
        .price-trends-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .trends-header {
            background: #f8f9fa;
            color: #333;
            padding: 14px 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            border-bottom: 1px solid #e0e0e0;
        }

        .trends-header:hover {
            background: #f1f3f5;
        }

        .trends-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
        }

        .trends-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .trends-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .trends-content.expanded {
            max-height: 800px;
        }

        .trends-body {
            padding: 20px 24px;
        }

        .trends-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
        }

        .trends-control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .trends-control-label {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trends-btn-group {
            display: flex;
            gap: 8px;
        }

        .trends-btn {
            padding: 8px 16px;
            background: #e9ecef;
            color: #333;
            border: 2px solid transparent;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trends-btn:hover {
            background: #dee2e6;
        }

        .trends-btn.active {
            background: #1e3a8a;
            color: white;
            border-color: #1e3a8a;
        }

        .trends-date-input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            color: #333;
        }

        .trends-date-input:focus {
            outline: none;
            border-color: #1e3a8a;
        }

        .trends-chart-container {
            position: relative;
            height: 400px;
            margin-top: 16px;
        }

        .trends-no-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #6c757d;
            font-size: 14px;
        }

        /* Pricing Tables */
        .pricing-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .section-header {
            background: #14213d;
            color: white;
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 600;
        }

        .pricing-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .pricing-table thead {
            background: #f8f9fa;
        }

        .pricing-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e0e0e0;
            vertical-align: top;
        }

        .pricing-table th:first-child {
            width: 120px;
        }

        .pricing-table th.price-col {
            text-align: center;
            width: auto;
            font-size: 12px;
            text-transform: none;
            max-width: 150px;  /* ADD THIS LINE */
            white-space: normal;  /* ADD THIS LINE */
            line-height: 1.3;  /* ADD THIS LINE */
        }

        .pricing-table tbody tr {
            transition: background 0.15s ease;
        }

        .pricing-table tbody tr:hover {
            background: #f8f9fa;
        }

        .pricing-table tbody tr.road-ranger-row {
            background: linear-gradient(90deg, #e3f2fd 0%, #f8f9fa 100%);
            font-weight: 600;
        }

        .pricing-table tbody tr.road-ranger-row:hover {
            background: linear-gradient(90deg, #d6eef6 0%, #f1f3f5 100%);
        }

        .pricing-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        .pricing-table td.fuel-type-label {
            font-weight: 600;
            color: #14213d;
            font-size: 14px;
        }

        .pricing-table td.price-cell {
            text-align: center;
            font-family: 'Courier New', monospace;
            font-weight: 600;
            font-size: 14px;
            vertical-align: middle;
        }

        .pricing-table td.road-ranger-cell {
            
            padding-top: 32px;
        }

        .price-value {
            font-size: 17px;
            color: #14213d;
            display: block;
            letter-spacing: 0.1px;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
        }

        .price-na {
            color: #999;
            font-weight: 400;
            font-size: 13px;
        }

        .price-diff {
            display: block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: 0.3px;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
        }

        .price-diff.cheaper {
            background: #dcfce7;
            color: #15803d;
        }

        .price-diff.more-expensive {
            background: #fee2e2;
            color: #b91c1c;
        }

        .price-diff.same {
            background: #f3f4f6;
            color: #6b7280;
        }

        .price-timestamp {
            display: block;
            font-size: 10px;
            color: #999;
            font-weight: 400;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin-top: 3px;
            line-height: 1.2;
        }

        .price-source {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            margin-left: 4px;
            letter-spacing: 0.3px;
        }

        .price-source.wex {
            background: #94a3b8;
        }

        .station-name {
            color: #333;
            font-weight: 500;
        }

        .road-ranger-row .station-name {
            color: #14213d;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rr-badge {
            background: #1e3a8a;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: inline-block;
            margin-bottom: 4px;
        }

        .distance-badge {
            display: inline-block;
            background: #e5e7eb;
            color: #6b7280;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            margin-top: 4px;
        }
        
        .distance-badge .price-source {
            margin-left: 6px;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* Position Indicator */
        .position-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            margin-right: 8px;
        }

        .position-indicator.best {
            background: #dcfce7;
            color: #15803d;
        }

        .position-indicator.worst {
            background: #fee2e2;
            color: #b91c1c;
        }

        .position-indicator.neutral {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* No data message */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-data h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: #666;
        }

        /* Scrollbar styling */
        .store-list::-webkit-scrollbar,
        .store-list-section::-webkit-scrollbar,
        .alert-content::-webkit-scrollbar,
        .content-area::-webkit-scrollbar,
        .competitor-list::-webkit-scrollbar {
            width: 8px;
        }

        .store-list::-webkit-scrollbar-track,
        .store-list-section::-webkit-scrollbar-track,
        .alert-content::-webkit-scrollbar-track,
        .content-area::-webkit-scrollbar-track,
        .competitor-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .store-list::-webkit-scrollbar-thumb,
        .store-list-section::-webkit-scrollbar-thumb,
        .alert-content::-webkit-scrollbar-thumb,
        .content-area::-webkit-scrollbar-thumb,
        .competitor-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .store-list::-webkit-scrollbar-thumb:hover,
        .store-list-section::-webkit-scrollbar-thumb:hover,
        .alert-content::-webkit-scrollbar-thumb:hover,
        .content-area::-webkit-scrollbar-thumb:hover,
        .competitor-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3a8a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Print styles */
        @media print {
            .store-list,
            .filter-header,
            .filter-content,
            .quick-actions {
                display: none;
            }

            .main-container {
                display: block;
                height: auto;
            }

            .content-area {
                padding: 0;
            }

            .pricing-section {
                box-shadow: none;
                page-break-inside: avoid;
            }
        }

        /* Settings Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .settings-modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 24px 32px;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #14213d;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px 32px;
        }

        .modal-search {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            margin-bottom: 24px;
        }

        .modal-search:focus {
            outline: none;
            border-color: #1e3a8a;
        }

        .store-settings-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .store-settings-card {
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            transition: all 0.2s ease;
        }

        .store-settings-card.hidden {
            display: none;
        }

        .store-settings-card:hover {
            border-color: #cbd5e1;
        }

        .store-settings-header {
            padding: 16px 20px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .store-settings-header:hover {
            background: #f8f9fa;
        }

        .store-settings-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .store-settings-number {
            font-size: 18px;
            font-weight: 700;
            color: #1e3a8a;
        }

        .store-settings-location {
            font-size: 14px;
            color: #666;
        }

        .store-settings-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
            color: #666;
        }

        .store-settings-toggle.expanded {
            transform: rotate(180deg);
        }

        .store-settings-body {
            padding: 0 20px 20px;
            display: none;
        }

        .store-settings-body.expanded {
            display: block;
        }

        .fuel-type-settings {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .fuel-type-settings:last-child {
            margin-bottom: 0;
        }

        .fuel-type-header {
            font-size: 15px;
            font-weight: 700;
            color: #14213d;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .threshold-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .threshold-input-group {
            display: flex;
            flex-direction: column;
        }

        .threshold-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .threshold-input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        .threshold-input:focus {
            outline: none;
            border-color: #1e3a8a;
        }

        .competitor-selection-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .competitor-selection-list {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px;
        }

        .competitor-selection-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 4px;
            transition: background 0.15s ease;
        }

        .competitor-selection-item:hover {
            background: #f8f9fa;
        }

        .competitor-selection-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
        }

        .competitor-selection-name {
            flex: 1;
            font-size: 13px;
            color: #333;
        }

        .competitor-selection-distance {
            font-size: 12px;
            color: #999;
            font-weight: 500;
        }

        .modal-footer {
            padding: 20px 32px;
            border-top: 2px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .modal-btn-secondary {
            background: #e5e7eb;
            color: #374151;
        }

        .modal-btn-secondary:hover {
            background: #d1d5db;
        }

        .modal-btn-primary {
            background: #1e3a8a;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #14213d;
        }

        /* Competitor dropdown positioning fix */
        .store-settings-card {
            overflow: visible !important;
        }

        .store-settings-body {
            overflow: visible !important;
        }

        .rule-creation-form {
            overflow: visible !important;
        }




        /* New Rule Creation Form */
        .rule-creation-form {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 2px solid #e0e0e0;
        }

        .rule-form-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .rule-select, .rule-input {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .rule-select:focus, .rule-input:focus {
            outline: none;
            border-color: #1e3a8a;
        }

        .rule-input {
            width: 100px;
        }

        .rule-cents-label {
            font-size: 14px;
            color: #666;
        }

        .rule-save-btn {
            padding: 8px 16px;
            background: #1e3a8a;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rule-save-btn:hover {
            background: #14213d;
        }

        /* Rules Display */
        .rules-display-section {
            margin-top: 16px;
        }

        .rules-display-header {
            font-size: 13px;
            font-weight: 700;
            color: #14213d;
            margin-bottom: 8px;
        }

        .rules-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .rule-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .rule-item:hover {
            border-color: #cbd5e1;
        }

        .rule-item-text {
            font-size: 14px;
            color: #333;
        }

        .rule-delete-btn {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .rule-delete-btn:hover {
            background: #fee2e2;
        }

        .rule-delete-btn svg {
            width: 20px;
            height: 20px;
        }

        .no-rules-message {
            font-size: 13px;
            color: #999;
            font-style: italic;
            padding: 12px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="rr-header">
        <div class="rr-header-container">
            <span class="rr-title">Road Ranger Pricing Index</span>
            <div class="header-info">
                <div class="last-updated" id="last-updated">Loading...</div>
                <button class="settings-btn" onclick="openSettingsModal()">
                    <span>‚öôÔ∏è</span>
                    <span>Alert Settings</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Store List Sidebar -->
        <div class="store-list">
            <!-- Alert Section -->
            <div class="alert-section">
                <div class="alert-header" onclick="toggleAlertSection()">
                    <div>
                        üîî Needs Attention
                        <span class="alert-count" id="alert-count">0</span>
                    </div>
                    <span class="alert-toggle" id="alert-toggle">‚ñº</span>
                </div>
                <div class="alert-content" id="alert-content">
                    <div class="alert-list" id="alert-list">
                        <!-- Alert items will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Store List Section -->
            <div class="store-list-section" id="store-list-items">
                <!-- Store items will be populated by JavaScript -->
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <div id="content">
                <div class="welcome-message">
                    <h2>Welcome to Road Ranger Pricing Index</h2>
                    <p>Select a Road Ranger location from the left to view competitive pricing analysis</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
         * PERSISTENT COMPETITOR SELECTIONS
         * ================================
         * This dashboard automatically saves competitor selections for each Road Ranger store.
         * Selections are saved in the browser's localStorage and will persist across sessions.
         * 
         * CUSTOM DEFAULT SELECTIONS
         * =========================
         * You can set custom default competitors for specific stores by editing the 
         * 'customDefaults' object below. 
         * 
         * Format:
         * customDefaults = {
         *     'storeNumber': ['Competitor Name 1', 'Competitor Name 2', ...],
         * }
         * 
         * Example:
         * customDefaults = {
         *     '118': ['CIRCLE K # 00190', 'SHELL SERVICE STATIO', 'CASEYS #2385'],
         *     '101': ['SPEEDWAY #1234', 'BP STATION'],
         * }
         * 
         * How it works:
         * 1. If user has previously saved selections use those (highest priority)
         * 2. Else if custom defaults exist for the store use those
         * 3. Else use top 10 closest competitors (default behavior)
         * 
         * The "Reset to Defaults" button clears saved selections and returns to 
         * either custom defaults (if set) or top 10 closest.
         */
        
        // Store data globally
        let rrData = [];
        let masterData = [];
        let currentStore = null;
        let visibleCompetitors = new Set();
        let alertStores = []; // Stores that need attention
        
        // Price Trends state
        let trendsFuelType = 'Regular';
        let trendsTimeFrame = 'Live';
        let trendsChart = null;
        let historicalData = [];
        let historicalDataCache = null; // Cache all historical data
        let historicalDataLoading = false; // Prevent duplicate loads
        let currentStoreHistoricalData = null; // Cache filtered data for current store
        
        // Alert rules - now stored per store and per fuel type
        let storeAlertSettings = {};  // { storeNumber: { fuelType: { cheaperThreshold, higherThreshold, competitors: [] } } }
        
        // Load store alert settings from localStorage
        function loadStoreAlertSettings() {
            try {
                const saved = localStorage.getItem('rrStoreAlertSettings');
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.warn('Error loading alert settings:', e);
                return {};
            }
        }
        
        // Save store alert settings to localStorage
        function saveStoreAlertSettings() {
            try {
                localStorage.setItem('rrStoreAlertSettings', JSON.stringify(storeAlertSettings));
            } catch (e) {
                console.warn('Error saving alert settings:', e);
            }
        }
        
        // Initialize alert settings
        storeAlertSettings = loadStoreAlertSettings();
        
        // Custom default selections for specific stores (by store number)
        // Format: { storeNumber: [competitorNames...] }
        // Format: { storeNumber: [competitorNames...] }
        const customDefaults = {
                '118': [
                'CIRCLE K # 01303|2120 N DIRKSEN PKWY|SPRINGFIELD',
                'CIRCLE K # 00190|2201 N DIRKSEN PKWY|SPRINGFIELD',
                'SHELL SERVICE STATIO|2121 N DIRKSEN PKWY|SPRINGFIELD',
                'CASEYS #2285|3001 RIDGE AVE|SPRINGFIELD',
                'SHELL SERVICE STATIO|2855 OVERPASS RD|RIVERTON',
                'SPEEDWAY 03961|4895 DINIUS RD|WILLIAMSVILLE'
            ],
            '132': [
                'PILOT #468|ADDRESS|NeedToAdd',
                'MURPHY 7231 ATWALMRT|1201 W FERDON ST|LITCHFIELD',
                'MEIJER STORE #146|2401 N PROSPECT AVE|CHAMPAIGN',
                'QUIKTRIP 7194|1505 N NEIL ST|CHAMPAIGN',
                'CIRCLE K # 1413|507 W UNIVERSITY AVE|URBANA',
                'PILOT #468|815 US HIGHWAY 24 W|GILMAN',
                'PILOT #468|ADDRESS|NeedToAdd'
            ],
            '136': [
                'BP 6293898|2763 COUNTY ROAD N|COTTAGE GROVE',
                'BP 1378500|1888 BARBER DR|STOUGHTON',
                'KWIK TRIP 893|1359 US HIGHWAY 51|STOUGHTON',
                "Love's Travel Stop in Dekorra - Poynette, WI. Store #637|W9493 County Road Cs|Dekorra - Poynette"
            ],
            '139': [
                "Love's Travel Stop in Tuscola, IL. Store #798|809 Moore Ave|Tuscola",
                'FUEL MART 787|1207 E SOUTHLINE RD|TUSCOLA',
                'FLYING J 643|1701 W EVERGREEN AVE|EFFINGHAM',
                'Pilot|2500 N 3RD ST|NeedToAdd(wexco doesnt grab it)',
                'LANMAN OIL CO.|1000 E SOUTHLINE RD|TUSCOLA',
                'IL 0229|314 E SOUTHLINE RD|TUSCOLA'
            ],
            '140': [
                'BP 9657560|1302 RAYMOND DR|MENDOTA',
                'MENDOTA CITGO|208 12TH ST|MENDOTA',
                "Love's Travel Stop in Utica , IL. Store #351|3020 E. 8th Rd.|Utica",
                "Love's Travel Stop in Oglesby, IL. Store #529|1001 W. Walnut St.|Oglesby"
            ],
            '141': [
                'BP 6623045|1030 W STATE ROAD 42|BRAZIL',
                'PETRO BRAZIL|1035 W STATE ROAD 4 2|BRAZIL',
                'PILOT SITE 444|4376 N STATE ROAD 59|BRAZIL',
                'SPEEDWAY|4425 N STATE ROUTE|NeedToAdd(not on wex)'
            ],
            '144': [
                'FLYING J 637|445 EVANSDALE DR|EVANSDALE',
                "Love's Travel Stop in Waterloo, IA. Store #702|3301 Greyhound Dr|Waterloo",
                'PILOT 1092|8950 EARHART LN SW|CEDAR RAPIDS'
            ],
            '145': [
                'QUIKTRIP 0642|1923 BOWLES AVE|FENTON,QUIKTRIP',
                'ROCKET 4229|222 SCHNEIDER DR|FENTON',
                'ROCKET 4233|698 GRAVOIS BLUFFS BLVD|FENTON',
                'PILOT|1475 THORNTON ST|PACIFIC NeedToAdd(not on wex)',
                'WALLYS|950 ASSEMBLY PKWY|FENTON',
                'QUIKTRIP 0641|604 BIG BEND RD|BALLWIN',
                'MR FUEL 717|3324 HIGHWAY 100|VILLA RIDGE',
                'FLYING J 645|1310 E CHAIN OF ROCKS RD|PONTOON BEACH',
                'LOVES|2007 N MAIN ST|NeedToAdd'
            ],
            '153': [
                'SHELL SERVICE STATIO|505 W IL ROUTE 38|ROCHELLE',
                'BP 2618800|1180 N 7TH ST|ROCHELLE',
                'BENNY\'S CORNER MARKE|601 FLAGG RD|ROCHELLE',
                'STOP-N-GO #1530|1000 S 7TH ST|ROCHELLE'
            ],
            '157': [
                'CIRCLE K 1350|107 W ELM ST|OKAWVILLE',
                "Love's Travel Stop in New Baden, IL. Store #583|8690 Richter School Rd|New Baden"
            ],
            '181': [
                'CIRCLE K SITE #0140|1201 TORONTO RD|SPRINGFIELD,CIRCLE K SITE',
                'QIK N EZ #61|1230 TORONTO RD|SPRINGFIELD,QIK N EZ #61',
                'JIFFI STOP 20|3062 ADLAI STEVENSON DR|SPRINGFIELD'
            ],
            '185': [
                'MINIT MART #0799|401 E SOUTH ST|MCLEAN',
                'CASEYS #2554|2017 FOX CREEK RD|BLOOMINGTON',
                'THORNTONS #222369|2903 WOODLAWN RD|LINCOLN'
            ],
            '186': [
                'CASEYS #1326|115 E 5TH ST|MINONK',
                "Love's Travel Stop in Normal, IL. Store #867|2007 N Main St|Normal",
                'PILOT|1522 W MARKET ST|NeedToAdd (not on wex)'
            ],
            '187': [
                'THORNTONS #221322 DIESE|3450 S CALIFORNIA AVE|CHICAGO',
                'MARATHON|3541 S CALIFORNIA AVE|CHICAGO(NeedToAdd)'
            ],
            '203': [
                "Love's Travel Stop in Rockford, IL. Store #775|4628 South Main Street|Rockford",
                'SOUTH MAIN MART|550 SOUTHROCK DR|ROCKFORD'
            ],
            '205': [
                'FLYING J 646|16049 WILLOWBROOK RD|SOUTH BELOIT',
                'KWIK TRIP #1276|16040 OAKFIELD PKWY|SOUTH BELOIT',
                'THORNTONS #221331 DIESE|13555 WILLOWBROOK RD|ROSCOE',
                'SPEEDWAY 3962|5951 E ROCKTON RD|ROSCOE(NeedToAddToSpeedwayScraper)',
                "Love's Travel Stop in Roscoe, IL. Store #322|13477 Quality Dr.|Roscoe",
                'PILOT|3001 MILWAUKEE RD|BELOIT(NeedToAdd not on wex)',
                'FAS. FUEL SHIRLAND|518 SHIRLAND AVE|SOUTH BELOIT'
            ],
            '206': [
                'WINNEBAGO CORNERS MA|903 N ELIDA ST|WINNEBAGO',
                'QUIKTRIP 4428|1555 SANDY HOLLOW RD|ROCKFORD'
            ],
            '209': [
                "Love's Travel Stop in Oakdale, WI. Store #345|220 Oakwood St.|Oakdale",
                'KWIK TRIP 775|611 GATEWAY AVE|MAUSTON',
                'PILOT|1101 GATEWAY AVE|MAUSTON(NeedToAdd not on wex)',
                'FLYING J|780 WI-54|BLACK RIVER FALLS(NeedToAdd not on wex)'
            ],
            '210': [
                'CIRCLEK# 4701408|1110 DEMENT RD|ROCHELLE',
                'PETRO CENTER ROCHELL|900 PETRO RD|ROCHELLE',
                'PILOT 1181|1201 E IL ROUTE 38|ROCHELLE',
                "Love's Travel Stop in Rochelle, IL. Store #754|400 Steward Road|Rochelle",
                "Love's Travel Stop in Monroe Center, IL. Store #851|16991 E Illinois Rte 72|Monroe Center"
            ],
            '211': [
                'TOLLWAY MOBIL|7490 E RIVERSIDE BLVD|LOVES PARK',
                'COSTCO|5000 STADIUM DR|LOVES PARK(NeedToAdd not on wex)',
                'CASEYS #3760|4001 INTERSTATE BLVD|LOVES PARK',
                'QUIKTRIP 7206|8070 E STATE ST|ROCKFORD'
            ],
            '225': [
                'SHELL SERVICE STATIO|2225 N MAIN ST|PRINCETON',
                'CASEYS #3531|2125 N MAIN ST|PRINCETON,CASEYS #3531',
                'BP 9157801|1838 N MAIN ST|PRINCETON,BP 9157801',
                'BECKS W PRINCE|605 W PERU ST|PRINCETON',
                'CASEYS #1837|520 W PERU ST|PRINCETON,CASEYS #1837',
                'SAPP BROTHERS ILLINOIS T|3130 MAY RD|PERU',
                'FLYING J 644|343 CIVIC RD|LA SALLE'
            ],
            '226': [
                'SPEEDWAY 43968|5 S GRAHAM RD|GREENWOOD',
                'CIRCLE K # 02287|1183 E MAIN ST|GREENWOOD',
                'PILOT|2962 E 500 N|WHITELAND(NeedToAdd not on wex)'
            ],
            '235': [
                'SPEEDWAY 5036|110 ARROWHEAD DR|HAMPSHIRE',
                "Love's Travel Stop in Hampshire, IL. Store #763|201 Love's Crossing|Hampshire",
                'BP 9573387|19N430 US-20|HAMPSHIRE',
                "Love's Travel Stop in Elk Grove Village, IL. Store #800|1900 Busse Rd|Elk Grove Village"
            ],
            '236': [
                'SCOTT OIL CO.INC|2526 MAIN ST|EAST TROY',
                'KWIK TRIP #1029|1880 MAIN ST|EAST TROY'
            ],
            '240': [
                'LUKE 235|2178 RIPLEY ST|LAKE STATION(NeedToAdd On Wex but not scraped)',
                'LAKE GOLO|3600 CENTRAL AVE|LAKE STATION(NeedToAdd On Wex but not scraped)',
                'FLYING J 650|1401 RIPLEY ST|LAKE STATION',
                'MR FUEL 1020|1235 RIPLEY ST|LAKE STATION'
            ],
            '242': [
                'CBS MINI MART|14130 HIGHWAY Z|SAINT ROBERT',
                'JONESYS TRAVEL CENTE|2031 W ELM ST|LEBANON',
                'L W PERUSSE OIL CO.|333 HIGHWAY Z|SAINT ROBERT',
                'ON THE RUN #250|122 SAINT ROBERT BLVD|SAINT ROBERT',
                'GIER OIL CO. INC.|681 OLD ROUTE 66|SAINT ROBERT',
                "Love's Travel Stop in Rolla , MO. Store #341|3500 Hy Point Ind. Park Dr.|Rolla",
                'FLYING J 673|825 N LOOP DR|SULLIVAN'
            ],
            '263': [
                'JOHNSON OIL CO.|3074 N STATE ROUTE 71|OTTAWA,JOHNSON OIL CO.',
                'THORNTONS #222364|102 W ETNA RD|OTTAWA,THORNTONS #222364',
                "Love's Travel Stop in Utica , IL. Store #351|3020 E. 8th Rd.|Utica",
                'PILOT 483|3801 N DIVISION ST|MORRIS'
            ],
            '265': [
                'CASEYS #4384|1751 S GALENA AVE|DIXON',
                'MURPHY 7165 ATWALMRT|1620 S GALENA AVE|DIXON'
            ],
            '266': [
                "Love's Travel Stop in South Jacksonville, IL. Store #687|201 Loves Dr|South Jacksonville"
            ],
            '267': [
                'SE 40665 PHARR TX|10701 S CAGE BLVD|PHARR',
                'RIVER MART|914 W MILITARY HWY|PHARR(NeedToAdd try to find it)',
                'SUNOCO SRVC STATION|7401 S JACKSON RD|PHARR'
            ],
            '268': [
                'CASEYS #2514|306 N COURT ST|GRAYVILLE',
                'HUCKS 101|552 N COURT ST|GRAYVILLE',
                "Love's Travel Stop in Haubstadt, IN. Store #414|901 East 1250 South|Haubstadt",
                'PILOT|4610 BROADWAY ST|MT VERNON(NeedToAdd not on wex)'
            ],
            '269': [
                'PILOT 1174|104 W TREFZ DR|MARSHALL',
                'SHELL SERVICE STATIO|1803 IL -1|MARSHALL',
                'CLARK COUNTY FUELS L|105 S MICHIGAN AVE|MARSHALL',
                'ONE9|5555 E MARGARET DR|TERRE HAUTE(NeedToAdd not on wex)',
                "Love's Travel Stop in Greenup, IL. Store #688|203 N Haughton Hwy|Greenup",
                'PILOT|2500 N 3RD ST|EFFINGHAM(NeedToAdd not on wex)'         
            ],
            '270': [
                "Love's Travel Stop in Natalia, TX. Store #471|21548 FM 471 S|Natalia",
                'PILOT|14555 INTERSTATE 35|VAN ORMY(NeedToAdd not on wex)',
                'RAM OIL LTD. LLP|1104 W COMAL ST|PEARSALL'
            ],
            '271': [
                'PILOT 1161|3145 METEOR CRATER RD|ODESSA',
                'ALLSUPS|3330 FM 866|ODESS(NeedToAdd not on wex)',
                'SHELL SERVICE STATIO|5934 W INTERSTATE 20|ODESSA',
                "Love's Travel Stop in Odessa , TX. Store #339|1901 W. I-20|Odessa",
                'PILOT 1207|101 S LOOP 464 RD|MONAHANS',
                'PILOT # 1147|127 W STATE HIGHWAY 302|KERMIT',
                'FLYING J #1206|700 E HWY 302|KERMIT'
            ],
            '272': [
                "Love's Travel Stop in Encinal, TX. Store #298|28527 I-35|Encinal",
                "Love's Travel Stop in Cotulla, TX. Store #862|1963 S IH 35|Cotulla"
            ],
            '273': [
                "Love's Travel Stop in Harlingen, TX. Store #885|21379 US 77 Expressway|Harlingen",
                '21469 US-77 FRONTAGE RD|HARLINGEN(NeedToAdd)',
                "Love's Travel Stop in Donna, TX. Store #739|545 W I-2|Donna",
                "Love's Travel Stop in Brownsville, TX. Store #767|3400 Nafta Parkway|Brownsville",
                "Love's Travel Stop in Kingsville, TX. Store #327|1451 N US Highway 77 Byp|Kingsville"
            ],
            '275': [
                'SUNOCO SRVC STATION|805 N CROCKETT AVE|SONORA',
                "Love's Travel Stop in Sonora, TX. Store #700|3880 Loop 467|Sonora",
                'PILOT|2342 N MAIN ST|JUNCTION(NeedToAdd on wex but not scraped)',
            ],
            '276': [
                'CHEVRON 0200164|705 NEW DALLAS HWY|LACY LAKEVIEW',
                'CIRCLE K #2741564|1301 N LOOP 340|LACY LAKEVIEW',
                'PILOT|2409 S NEW RD|WACO(NeedToaAdd on wex but not scraped)',
                'PILOT|8055 S IH 35|ROBINSON(NeedToAdd not on wex)',
                'ABBOTT TRAVEL CENTER|1197 IH 35 S|ABBOTT',
                "Love's Travel Stop in Hillsboro, TX. Store #231|1501 Corsicana Hwy|Hillsboro"
            ],
            '277': [
                'CIRCLE K|905 N MCCOY BLVD|NEW BOSTON(NeedToAdd not on wex)',
                'PARADISE QUICKSTOP #|900 N MCCOY BLVD|NEW BOSTON',
                'SHELL SERVICE STATIO|708 N MCCOY BLVD|NEW BOSTON',
                'TIGER MART 88|1888 W US HIGHWAY 82|NEW BOSTON',
                "Love's Travel Stop in New Boston, TX. Store #852|2486 US Hwy-82 W|New Boston",
                "Love's Travel Stop in Leary, TX. Store #473|451 Leary Road|Leary"
            ],
            '278': [
                'BRINKLEY MOBIL JFS #|2102 N HWY 49|BRINKLEY',
                'HARI FOOD MART|1920 N MAIN ST|BRINKLEY',
                'ONE9|2101 HWY 49|BRINKLEY(NeedToAdd not on wex)',
                'JORDANS KWIK STOP #8|1414 N MAIN ST|BRINKLEY',
                "Love's Travel Stop in Palestine, AR. Store #275|1010 N Main St|Palestine"
            ],
            '279': [
                'SHAH PETROLEUM LLC|1754 ILLINOIS 37|MARION,SHAH PETROLEUM LLC',
                'CASEYS #3391|2314 W MAIN ST|MARION,CASEYS #3391',
                'PILOT #595|2611 VERNELL RD|MARION',
                "Love's Travel Stop in Marion, IL. Store #803|1900 The Hill Ave|Marion",
            ],
            '280': [
                'QUIKTRIP 7913|1907 S STOCKTON AVE|MONAHANS',
                'PILOT 1207|101 S LOOP 464 RD|MONAHANS',
                'PILOT|4840 I-20|MONAHANS(NeedToAdd)',
                'FLYING J #1206|700 E HWY 302|KERMIT',
                "Love's Travel Stop in Kermit, TX. Store #853|674 E State Hwy 302|Kermit",
                "Love's Travel Stop in Pecos, TX. Store #492|5202 South Cedar St.|Pecos"
            ],
            '281': [
                "ALLSUP'S 102105|2205 CONRAD HILTON BLVD|CISCO",
                'SUNOCO SRVC STATION|1500 INTERSTATE 20 W|CISCO',
                'SHELL SERVICE STATIO|16851 INTERSTATE 20|CISCO',
                "Love's Travel Stop in Ranger, TX. Store #270|6950 I-20|Ranger"
            ],
            '282': [
                'GAINESVILLE TRUCK ST.|3590 N INTERSTATE 35|GAINESVILLE',
                'XPRESSWAY VALERO|1934 N INTERSTATE 35|GAINESVILLE',
                'QUIKTRIP 1883|926 W HIGHWAY 82|GAINESVILLE',
                "Love's Travel Stop in Denton, TX. Store #609|6421 N I-35|Denton"
            ],
            '283': [
                'NEED TO MAKE ROAD RANGER GET SCRAPED FROM WEX THEN HANDLE THIS'
            ],
            '284': [
                'HOP IN 430469|101 E MAIN ST|NEW DEAL',
                "Love's Travel Stop in Lubbock, TX. Store #589|4221 North Interstate 27|Lubbock",
                'SEI FUELS STORE 4252|2424 N LOOP 289|LUBBOCK',
                'FLYING J 733|602 MARSHA SHARP FWY|LUBBOCK',
                "TOOT'N TOTUM #138|5202 ERSKINE ST|LUBBOCK",
                'ROOTS SLAYTON|1755 S 9TH ST|SLATON'
            ],
            '285': [
                'CK. SITE #4028|1805 W INTERSTATE 10|SEGUIN',
                'CHEVRON 0383946|1810 W INTERSTATE 10|SEGUIN(NeedToAdd on wex but not scraped)',
                "Love's Travel Stop in Seguin, TX. Store #463|3158 I-10 W|Seguin",
                'QUIKTRIP 4044|200 E INTERSTATE 10|SEGUIN(NeedToAdd on wex but not scraped)',
                'SHELL SERVICE STATIO|2718 FM 725|NEW BRAUNFELS'
            ],
            '286': [
                'NATIONAL TRUCK STOP|11301 E INTERSTATE|AMARILLO',
                'BUC-EES|9900 I-40 E|AMARILLO(NeedToAdd not on wex)',
                'FLYING J 723|9601 I40 E EXIT 76|AMARILLO',
                "TOOT'N TOTUM #99|8507 E INTERSTATE 40|AMARILLO",
                'TA AMARILLO|7000 E INTERSTATE 4 0|AMARILLO',
                "Love's Travel Stop in Amarillo, TX. Store #200|6930 I-40 E.|Amarillo",
                'CEFCO 2005|5000 E INTERSTATE 40|AMARILLO',
                'QUIKTRIP 7908|5105 E INTERSTATE 40|AMARILLO'
            ],
            '287': [
                'LENNYS GAS N WASH BO|5916 N CONVENT ST|BOURBONNAIS',
                'SPEEDWAY 43593|604 ARMOUR RD|BOURBONNAIS',
                'SHELL SERVICE STATIO|601 S 88TH AVE|PEOTONE',
                "Love's Travel Stop in Kankakee, IL. Store #395|3407 South State Road 45/52|Kankakee",
                'PILOT|6002 W MONEE MANHATTAN RD|MONEE(NeedToAdd not on wex)'
            ],
            '289': [
                'JET TRUCK STOP|771 STATE HIGHWAY 179|TEAGUE',
                'TA EXPRESS FAIRFIELD|300 E I 45|FAIRFIELD',
                "Love's Travel Stop in Hillsboro, TX. Store #231|1501 Corsicana Hwy|Hillsboro",
                'PILOT 1028|2605 W COMMERCE ST|BUFFALO',
                "Love's Travel Stop in Fairfield, TX. Store #288|299 I-45|Fairfield"
            ],
            '290': [
                'PRIGMORE AVE. 66|2100 S PRIGMORE AVE|JOPLIN',
                'QUIKTRIP 7061|6601 E 32ND ST|JOPLIN',
                'PILOT|4500 STATE HWY 43|SPRINGFIELD(NeedToAdd not on wex)'
            ],
            '312': [
                'VALERO 2740969|1010 N MAIN ST|VIDOR',
                'FUEL BOX LLC|2410 N MAIN ST|VIDOR',
                'SHELL SERVICE STATIO|12330 IH-10|ORANGE',
                'GATEWAY TRAVEL PLAZA|22965 INTERSTATE 10|VIDOR',
                'PILOT|2205 HIGHWAY 62 S|ORANGE(NeedToAdd)',
                'PILOT|7112 I-10 W|ORANGE(NeedToAdd)'
            ],
            '315': [
                "Love's Travel Stop in Laredo, TX. Store #762|101 Pinnacle Road|Laredo"
            ],
            '319': [
                "Love's Travel Stop in Hillsboro, TX. Store #231|1501 Corsicana Hwy|Hillsboro",
                'SHELL SERVICE STATIO|1020 DALE EVANS DR|ITALY',
                'TIGER MART #32|101 L R CAMPBELL RD|ITALY',
                'SHELL SERVICE STATIO|160 STATE HIGHWAY 77|HILLSBORO',
                "Love's Travel Stop in Italy, TX. Store #628|1021 Dale Evans Dr|Italy"
            ],
            '323': [
                'NAT 24 CANTON|17169 INTERSTATE 20|CANTON',
                'CIRCLEK# 2706340|2256 N TRADE DAYS BLVD|CANTON',
                'SHELL SERVICE STATIO|21620 INTERSTATE 20|CANTON',
                'SHELL SERVICE STATIO|9800 INTERSTATE 20|CANTON',
                "Love's Travel Stop in Van, TX. Store #287|1221 S. Oak St|Van",
                'SHELL SERVICE STATIO|1700 WILSON RD|TERRELL',
                'QUIKTRIP 0993|1619 STATE HIGHWAY 34 S|TERRELL',
                'BUC-EES|506 I-20|TERRELL(NeedToAdd not on wex)'
            ],
        };
        
        // Load saved competitor selections from localStorage
        function loadSavedSelections() {
            try {
                const saved = localStorage.getItem('rrCompetitorSelections');
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.warn('Error loading saved selections:', e);
                return {};
            }
        }
        
        // Save competitor selections to localStorage
        function saveSelections(storeNumber, competitorIndices) {
            try {
                const allSelections = loadSavedSelections();
                allSelections[storeNumber] = Array.from(competitorIndices);
                localStorage.setItem('rrCompetitorSelections', JSON.stringify(allSelections));
            } catch (e) {
                console.warn('Error saving selections:', e);
            }
        }
        
        // Get saved or default selections for a store
        function getSavedOrDefaultSelections(storeNumber, competitors) {
            // First, check if user has saved selections
            const allSelections = loadSavedSelections();
            if (allSelections[storeNumber]) {
                return new Set(allSelections[storeNumber]);
            }
            
            // Next, check if there are custom defaults for this store
            if (customDefaults[storeNumber]) {
                const defaultNames = customDefaults[storeNumber];
                const indices = new Set();
                
                competitors.forEach((comp, idx) => {
                    if (defaultNames.includes(comp.Station_ID)) {
                        indices.add(idx);
                    }
                });
                
                if (indices.size > 0) {
                    return indices;
                }
            }
            
            // Finally, fall back to top 10 closest
            return new Set(competitors.slice(0, 10).map((_, idx) => idx));
        }
        
        // Normalize station names to fix common misspellings and formatting issues
        function normalizeStationName(name) {
            if (!name) return name;
            
            // Define replacement rules
            const replacements = {
                // Fix truncated words
                'STATIO': 'STATION',
                'ATWALMRT': 'AT WALMART',
                'ATWALMART': 'AT WALMART',
                
                // Fix common misspellings
                'SEVICE': 'SERVICE',
                'SERVCE': 'SERVICE',
                'STAION': 'STATION',
                
                // Standardize spacing around numbers
                'MURPHY(\\d+)': 'MURPHY $1',
                '(\\d+)ATWALMRT': '$1 AT WALMART',
                
                // Add more as needed
            };
            
            let normalized = name;
            
            // Apply each replacement rule
            for (const [pattern, replacement] of Object.entries(replacements)) {
                const regex = new RegExp(pattern, 'gi');
                normalized = normalized.replace(regex, replacement);
            }
            
            // Clean up extra spaces
            normalized = normalized.replace(/\s+/g, ' ').trim();
            
            return normalized;
        }


        // Load the data files
        async function loadData() {
            try {
                // Always load from master_price_data.csv (always kept up-to-date)
                const csvFilename = 'master_price_data.csv';
                
                console.log(`Loading pricing data from: ${csvFilename}`);

                // Load Master pricing data (CSV)
                const masterResponse = await fetch(csvFilename);
                const masterText = await masterResponse.text();
                masterData = parseCSV(masterText);

                console.log(`Loaded ${masterData.length} stations from ${csvFilename}`);

                // Check if we have data
                if (masterData.length === 0) {
                    throw new Error('No data found in CSV file');
                }

                // Log sample row to verify structure
                if (masterData.length > 0) {
                    console.log('Sample row:', masterData[0]);
                    console.log('Available columns:', Object.keys(masterData[0]));
                }

                // Extract unique Road Ranger locations from the CSV
                const rrLocationsMap = new Map();
                masterData.forEach((row, index) => {
                    if (row.RR_Location && row.RR_Location.trim() !== '' && !rrLocationsMap.has(row.RR_Location)) {
                        // Create data structure matching what the rest of the code expects
                        const locationData = {
                            rr_store: row.RR_Location,  // e.g., "Road Ranger #118 - Springfield, IL"
                            rr_store_data: {
                                name: row.RR_Location,
                                latitude: parseFloat(row.RR_Latitude) || 0,
                                longitude: parseFloat(row.RR_Longitude) || 0
                            }
                        };
                        rrLocationsMap.set(row.RR_Location, locationData);
                        
                        // Debug first location
                        if (rrLocationsMap.size === 1) {
                            console.log('First location created:', locationData);
                        }
                    }
                });
                rrData = Array.from(rrLocationsMap.values());
                // Sort Road Ranger locations numerically by store number
                rrData.sort((a, b) => {
                    // Extract numbers from "Road Ranger #123" format
                    const numA = parseInt(a.rr_store.replace(/\D/g, ''));
                    const numB = parseInt(b.rr_store.replace(/\D/g, ''));
                    return numA - numB;
                });
                
                console.log(`Extracted ${rrData.length} Road Ranger locations`);
                
                if (rrData.length === 0) {
                    throw new Error('No Road Ranger locations found in CSV. Check RR_Location column.');
                }

                // Update last updated time
                updateLastUpdatedTime();

                // Populate store list (this will also update alerts)
                populateStoreList();
                
                // Preload historical data in the background for faster trends loading
                setTimeout(() => {
                    console.log('Preloading historical data in background...');
                    loadHistoricalData();
                }, 1000); // Wait 1 second to let UI render first
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('content').innerHTML = `
                    <div class="no-data">
                        <h3>Error Loading Data</h3>
                        <p>Please ensure master_price_data.csv is in the same directory as this HTML file.</p>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Update the last updated time in the header
        function updateLastUpdatedTime() {
            // Find the most recent timestamp from the data
            let latestTimestamp = null;
            
            masterData.forEach(row => {
                // Check API_Updated_Time first (most reliable)
                if (row.API_Updated_Time && row.API_Updated_Time !== '' && row.API_Updated_Time !== 'None') {
                    const timestamp = new Date(row.API_Updated_Time);
                    if (!isNaN(timestamp.getTime())) {
                        if (!latestTimestamp || timestamp > latestTimestamp) {
                            latestTimestamp = timestamp;
                        }
                    }
                }
                // Fall back to Transaction_Time
                else if (row.Transaction_Time && row.Transaction_Time !== '' && row.Transaction_Time !== 'None') {
                    const timestamp = new Date(row.Transaction_Time);
                    if (!isNaN(timestamp.getTime())) {
                        if (!latestTimestamp || timestamp > latestTimestamp) {
                            latestTimestamp = timestamp;
                        }
                    }
                }
            });
            
            // If we found a timestamp, use it; otherwise use current time
            const date = latestTimestamp || new Date();
            const formattedDate = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric',
                timeZone: 'America/Chicago'
            });
            const formattedTime = date.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true,
                timeZone: 'America/Chicago'
            });
            
            document.getElementById('last-updated').textContent = `Last Updated: ${formattedDate} at ${formattedTime}`;
        }

        // Toggle alert section dropdown
        function toggleAlertSection() {
            const content = document.getElementById('alert-content');
            const toggle = document.getElementById('alert-toggle');
            
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }



        // Check if a store needs attention based on alert rules
        function checkStoreAlerts(store) {
            const storeNumber = store.rr_store.replace('Road Ranger #', '').split(' - ')[0];
            const storeName = store.rr_store_data.name;
            
            // Get all stations for this location
            const allStations = masterData
                .filter(row => row.RR_Location === storeName)
                .sort((a, b) => parseFloat(a.Distance || 999) - parseFloat(b.Distance || 999));
            
            const rrStation = allStations.find(row => row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            if (!rrStation) return null;
            
            const competitors = allStations.filter(row => !row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            
            // Get rules for this store
            const storeRules = storeAlertSettings[storeNumber]?.rules || [];
            if (storeRules.length === 0) return null; // No rules set, no alerts
            
            const alerts = [];
            
            // Fuel type mapping
            const fuelTypeMap = {
                'Regular': 'Unleaded_Regular_Price',
                'Mid-Grade': 'Unleaded_Plus_Price',
                'Premium': 'Unleaded_Premium_Price',
                'Diesel': 'Diesel_Regular_Price'
            };
            
            // Check each rule
            storeRules.forEach(rule => {
                const priceKey = fuelTypeMap[rule.fuelType];
                if (!priceKey) return;
                
                const rrPrice = parseFloat(rrStation[priceKey]);
                if (isNaN(rrPrice)) return;
                
                // Find the competitor station that matches this rule
                const matchingCompetitors = competitors.filter(comp => {
                    return comp.Station_Name === rule.competitor;
                });
                
                matchingCompetitors.forEach(comp => {
                    const compPrice = parseFloat(comp[priceKey]);
                    if (isNaN(compPrice)) return;
                    
                    const distance = parseFloat(comp.Distance || 999);
                    if (distance > 10) return; // Only check within 10 miles
                    
                    const diffCents = (compPrice - rrPrice) * 100; // Positive = competitor higher, Negative = competitor lower
                    
                    // Check if rule condition is met
                    if (rule.direction === 'Higher') {
                        // Alert if competitor is HIGHER than us by rule.cents
                        if (diffCents >= rule.cents) {
                            alerts.push({
                                type: 'overpriced',
                                fuelType: rule.fuelType,
                                competitor: rule.competitor,
                                difference: Math.abs(diffCents).toFixed(1)
                            });
                        }
                    } else if (rule.direction === 'Lower') {
                        // Alert if competitor is LOWER than us by rule.cents
                        if (diffCents <= -rule.cents) {
                            alerts.push({
                                type: 'underpriced',
                                fuelType: rule.fuelType,
                                competitor: rule.competitor,
                                difference: Math.abs(diffCents).toFixed(1)
                            });
                        }
                    }
                });
            });
            
            if (alerts.length > 0) {
                return {
                    store,
                    storeNumber,
                    storeName,
                    alerts
                };
            }
            
            return null;
        }

        // Update alerts for all stores
        function updateAlerts() {
            // Check all stores
            alertStores = [];
            rrData.forEach(store => {
                const alert = checkStoreAlerts(store);
                if (alert) {
                    alertStores.push(alert);
                }
            });
            
            // Update alert list
            renderAlertList();
        }

        // Render the alert list
        function renderAlertList() {
            const alertList = document.getElementById('alert-list');
            const alertCount = document.getElementById('alert-count');
            const alertHeader = document.querySelector('.alert-header');
            
            if (!alertList || !alertCount) return;
            
            alertCount.textContent = alertStores.length;
            
            // Update header color based on alert count
            if (alertStores.length === 0) {
                alertHeader.classList.add('no-alerts');
            } else {
                alertHeader.classList.remove('no-alerts');
            }
            
            if (alertStores.length === 0) {
                alertList.innerHTML = `
                    <div class="no-alerts">
                        <div>All stores looking good!</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            alertStores.forEach((alertData, index) => {
                const storeNumber = alertData.storeNumber;
                const city = alertData.store.rr_store.split(' - ')[1] || '';
                
                // Find the index of this store in rrData
                const storeIndex = rrData.findIndex(s => s.rr_store === alertData.store.rr_store);
                
                // Group alerts to show most important ones
                const underpricedAlerts = alertData.alerts.filter(a => a.type === 'underpriced');
                const overpricedAlerts = alertData.alerts.filter(a => a.type === 'overpriced');
                
                // Build alert reasons - show up to 2 specific alerts
                let alertReasons = [];
                
                // Show underpriced alerts first (higher priority)
                underpricedAlerts.slice(0, 2).forEach(alert => {
                    const shortName = alert.competitor.length > 20 
                        ? alert.competitor.substring(0, 20) + '...' 
                        : alert.competitor;
                    alertReasons.push(`Underpriced: ${shortName}, ${alert.fuelType}, ${alert.difference}¬¢`);
                });
                
                // If room, show overpriced alerts
                if (alertReasons.length < 2) {
                    overpricedAlerts.slice(0, 2 - alertReasons.length).forEach(alert => {
                        const shortName = alert.competitor.length > 20 
                            ? alert.competitor.substring(0, 20) + '...' 
                            : alert.competitor;
                        alertReasons.push(`Overpriced: ${shortName}, ${alert.fuelType}, ${alert.difference}¬¢`);
                    });
                }
                
                // If more alerts exist, add a count
                const remainingCount = alertData.alerts.length - alertReasons.length;
                if (remainingCount > 0) {
                    alertReasons.push(`+${remainingCount} more`);
                }
                
                html += `
                    <div class="alert-store-item" onclick="selectStore(${storeIndex})">
                        <div class="alert-store-number">#${storeNumber}</div>
                        ${alertReasons.map(reason => `<div class="alert-store-reason">${reason}</div>`).join('')}
                        <div class="alert-store-city">${city}</div>
                    </div>
                `;
            });
            
            alertList.innerHTML = html;
        }

        // Parse CSV data
        function parseCSV(text) {
            // Normalize line endings (handle both \r\n and \n)
            text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = text.split('\n');
            const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, '').trim());
            const data = [];

            console.log('CSV Headers:', headers);

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                try {
                    const values = parseCSVLine(lines[i]);
                    const row = {};
                    
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    
                    data.push(row);
                } catch (err) {
                    console.warn(`Error parsing line ${i}:`, err);
                }
            }

            return data;
        }

        // Parse a single CSV line (handles quoted values)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else if (char !== '\r') {  // Skip carriage returns
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Populate the store list
        function populateStoreList() {
            const container = document.getElementById('store-list-items');
            
            rrData.forEach((location, index) => {
                // Extract store number from "Road Ranger #118 - Springfield, IL"
                const storeNumber = location.rr_store.replace('Road Ranger #', '').split(' - ')[0];
                const storeName = location.rr_store_data.name;
                const storeCity = location.rr_store.split(' - ')[1] || '';
                
                const item = document.createElement('div');
                item.className = 'store-item';
                item.innerHTML = `
                    <div>
                        <div class="store-number">#${storeNumber}</div>
                        <div class="store-name">${storeCity}</div>
                    </div>
                `;
                item.onclick = () => selectStore(index);
                
                container.appendChild(item);
            });
            
            // Update alerts after populating store list
            updateAlerts();
        }

        // Select a store and display its pricing
        function selectStore(index) {
            // Update active state for both regular stores and alert stores
            const items = document.querySelectorAll('.store-item, .alert-store-item');
            items.forEach(item => item.classList.remove('active'));
            
            // Set active on the regular store item
            const storeItems = document.querySelectorAll('.store-item');
            if (storeItems[index]) {
                storeItems[index].classList.add('active');
            }

            // Store current selection
            currentStore = rrData[index];
            
            // Display pricing
            displayStorePricing(currentStore);
        }

        // Display pricing for selected store
        function displayStorePricing(store) {
            // Clean up chart if it exists
            if (trendsChart) {
                trendsChart.destroy();
                trendsChart = null;
            }
            
            // Store current selection
            currentStore = store;
            
            // Filter historical data for the new store (if data is already loaded)
            if (historicalDataCache !== null) {
                filterHistoricalDataForCurrentStore();
            }
            
            // Extract store number from "Road Ranger #118 - Springfield, IL"
            const storeNumber = store.rr_store.replace('Road Ranger #', '').split(' - ')[0];
            const storeName = store.rr_store_data.name;
            
            // Get all stations for this location from master data
            const allStations = masterData
                .filter(row => row.RR_Location === storeName)
                .sort((a, b) => parseFloat(a.Distance || 999) - parseFloat(b.Distance || 999));

            console.log(`Found ${allStations.length} stations for ${storeName}`);

            // Find Road Ranger station in master data
            const rrStation = allStations.find(row => row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            
            // Get all competitors (excluding Road Ranger)
            const competitors = allStations
                .filter(row => !row.Station_Name.toUpperCase().includes('ROAD RANGER'));

            // Load saved selections, custom defaults, or use top 10 by default
            visibleCompetitors = getSavedOrDefaultSelections(storeNumber, competitors);

            // Build the pricing display
            renderPricingDisplay(storeNumber, storeName, rrStation, competitors);
        }

        // Render the pricing display
        function renderPricingDisplay(storeNumber, storeName, rrStation, competitors) {
            let html = `
                <div class="store-details">
                    <div class="store-header">
                        <div class="store-header-left">
                            <h2>Road Ranger #${storeNumber}</h2>
                            <p class="store-location">${storeName}</p>
                        </div>
                        <div class="store-header-right">
                            <div class="quick-actions">
                                <button class="action-btn" onclick="window.print()">Print</button>
                                <button class="action-btn" onclick="exportToCSV()">Export CSV</button>
                            </div>
                        </div>
                    </div>
            `;

            // Add Price Trends section
            html += `
                <div class="price-trends-section">
                    <div class="trends-header" onclick="toggleTrendsDropdown()">
                        <span>Price Trends</span>
                        <span class="trends-toggle collapsed" id="trends-toggle">&#8592</span>
                    </div>
                    <div class="trends-content collapsed" id="trends-content">
                        <div class="trends-body">
                            <div class="trends-controls">
                                <!-- Fuel Type Selector -->
                                <div class="trends-control-group">
                                    <label class="trends-control-label">Fuel Type</label>
                                    <div class="trends-btn-group">
                                        <button class="trends-btn active" onclick="selectTrendsFuelType('Regular')">Regular</button>
                                        <button class="trends-btn" onclick="selectTrendsFuelType('Midgrade')">Midgrade</button>
                                        <button class="trends-btn" onclick="selectTrendsFuelType('Premium')">Premium</button>
                                        <button class="trends-btn" onclick="selectTrendsFuelType('Diesel')">Diesel</button>
                                    </div>
                                </div>

                                <!-- Time Frame Selector -->
                                <div class="trends-control-group">
                                    <label class="trends-control-label">Time Frame</label>
                                    <div class="trends-btn-group">
                                        <button class="trends-btn active" onclick="selectTrendsTimeFrame('Live')">Live (24h)</button>
                                        <button class="trends-btn" onclick="selectTrendsTimeFrame('7 Days')">7 Days</button>
                                        <button class="trends-btn" onclick="selectTrendsTimeFrame('Custom')">Custom</button>
                                    </div>
                                </div>

                                <!-- Custom Date Range -->
                                <div class="trends-control-group" id="custom-date-range" style="display: none;">
                                    <label class="trends-control-label">Date Range</label>
                                    <div class="trends-btn-group">
                                        <input type="date" class="trends-date-input" id="trends-start-date">
                                        <input type="date" class="trends-date-input" id="trends-end-date">
                                    </div>
                                </div>
                            </div>

                            <!-- Chart Container -->
                            <div class="trends-chart-container">
                                <canvas id="price-trends-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add competitor filter section
            if (competitors.length > 0) {
                html += `
                    <div class="competitor-filter-section">
                        <div class="filter-header" onclick="toggleFilterDropdown()">
                            <span>Competitor Filter (${visibleCompetitors.size} of ${competitors.length} selected)</span>
                            <span class="filter-toggle collapsed" id="filter-toggle">&#8592</span>
                        </div>
                        <div class="filter-content collapsed" id="filter-content">
                            <div class="filter-body">
                                <div class="filter-controls">
                                    <button class="filter-btn" onclick="selectAllCompetitors()">Select All</button>
                                    <button class="filter-btn" onclick="deselectAllCompetitors()">Deselect All</button>
                                    <button class="filter-btn" onclick="selectTop10Competitors()">Top 10 Closest</button>
                                    <button class="filter-btn" onclick="resetToDefaults()" title="Reset to custom defaults or top 10">Reset to Defaults</button>
                                    <input type="text" class="filter-search" id="competitor-search" placeholder="Search competitors..." />
                                </div>
                                <div class="competitor-list" id="competitor-list">
                `;

                // Add checkboxes for each competitor
                competitors.forEach((comp, idx) => {
                    const distance = parseFloat(comp.Distance || 0).toFixed(1);
                    const isChecked = visibleCompetitors.has(idx) ? 'checked' : '';
                    html += `
                        <div class="competitor-checkbox-item" data-competitor-index="${idx}">
                            <input type="checkbox" id="comp-${idx}" ${isChecked} onchange="toggleCompetitor(${idx})">
                            <label for="comp-${idx}" class="competitor-checkbox-label">
                                <span class="competitor-checkbox-name">${normalizeStationName(comp.Station_Name)}</span>
                                <span class="competitor-checkbox-distance">${distance} mi</span>
                            </label>
                        </div>
                    `;
                });

                html += `
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Add pricing table
            html += `
                <div class="pricing-section">
                    <div class="section-header">
                        Fuel Price Comparison
                    </div>
                    <div id="pricing-table-container">
            `;

            html += renderPricingTable(storeNumber, rrStation, competitors);

            html += `
                    </div>
                </div>
            </div>
            `;

            document.getElementById('content').innerHTML = html;

            // Set up competitor search
            if (competitors.length > 0) {
                setupCompetitorSearch();
            }
        }

        // Render the pricing table based on visible competitors
        function renderPricingTable(storeNumber, rrStation, competitors) {
            // Get only visible competitors
            const visibleComps = competitors.filter((_, idx) => visibleCompetitors.has(idx));

            if (visibleComps.length === 0) {
                return `
                    <div class="no-data">
                        <h3>No Competitors Selected</h3>
                        <p>Please select at least one competitor from the filter above.</p>
                    </div>
                `;
            }

            // Build table with fuel types as rows and stations as columns
            let html = `
                <table class="pricing-table">
                    <thead>
                        <tr>
                            <th>Fuel Type</th>
                            <th class="price-col">
                                <span class="rr-badge">ROAD RANGER</span><br>
                                ${rrStation && rrStation.API_Updated !== 'Yes' ? '<span class="price-source wex">WEX</span>' : ''}
                            </th>
            `;

            // Add competitor columns
            visibleComps.forEach(comp => {
                const distance = parseFloat(comp.Distance || 0).toFixed(1);
                // Determine source from first available price
                const isApiPrice = comp.API_Updated === 'Yes';
                const sourceLabel = isApiPrice ? 'API' : 'WEX';
                const sourceClass = isApiPrice ? '' : 'wex';
                html += `
                    <th class="price-col">
                        ${normalizeStationName(comp.Station_Name)}<br>
                        <span class="distance-badge">${distance} mi <span class="price-source ${sourceClass}">${sourceLabel}</span></span>
                    </th>
                `;
            });

            html += `
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Add fuel type rows
            const fuelTypes = [
                { key: 'Unleaded_Regular_Price', name: 'Regular' },
                { key: 'Unleaded_Plus_Price', name: 'Mid-Grade' },
                { key: 'Unleaded_Premium_Price', name: 'Premium' },
                { key: 'Diesel_Regular_Price', name: 'Diesel' }
            ];

            fuelTypes.forEach(fuelType => {
                html += `<tr>`;
                html += `<td class="fuel-type-label">${fuelType.name}</td>`;
                
                // Road Ranger price
                html += `<td class="price-cell road-ranger-cell">`;
                if (rrStation) {
                    html += formatPrice(rrStation[fuelType.key], rrStation.API_Updated_Time || rrStation.Transaction_Time, rrStation.API_Updated, null, false);
                } else {
                    html += '<span class="price-na">N/A</span>';
                }
                html += `</td>`;
                
                // Competitor prices
                visibleComps.forEach(comp => {
                    html += `<td class="price-cell">`;
                    html += formatPriceWithDiff(comp[fuelType.key], rrStation?.[fuelType.key], comp.API_Updated_Time || comp.Transaction_Time, comp.API_Updated, null);
                    html += `</td>`;
                });
                
                html += `</tr>`;
            });

            html += `
                    </tbody>
                </table>
            `;

            return html;
        }

        // ===== PRICE TRENDS FUNCTIONS =====

        // Toggle Price Trends dropdown
        function toggleTrendsDropdown() {
            const content = document.getElementById('trends-content');
            const toggle = document.getElementById('trends-toggle');
            
            const wasCollapsed = content.classList.contains('collapsed');
            content.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            toggle.classList.toggle('collapsed');
            
            // Only initialize on first expand
            if (wasCollapsed && !trendsChart) {
                initializeTrendsChart();
            } else if (wasCollapsed && trendsChart) {
                // Chart already exists, just update it
                updateTrendsChart();
            }
        }

        // Select fuel type for trends
        function selectTrendsFuelType(fuelType) {
            trendsFuelType = fuelType;
            
            // Update button states
            const buttons = document.querySelectorAll('.trends-control-group:first-child .trends-btn');
            buttons.forEach(btn => {
                if (btn.textContent === fuelType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Update chart
            updateTrendsChart();
        }

        // Select time frame for trends
        function selectTrendsTimeFrame(timeFrame) {
            trendsTimeFrame = timeFrame;
            
            // Update button states
            const buttons = document.querySelectorAll('.trends-control-group:nth-child(2) .trends-btn');
            buttons.forEach(btn => {
                const btnText = btn.textContent.includes('Live') ? 'Live' : 
                               btn.textContent.includes('7 Days') ? '7 Days' : 'Custom';
                if (btnText === timeFrame) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Show/hide custom date range
            const customDateRange = document.getElementById('custom-date-range');
            if (timeFrame === 'Custom') {
                customDateRange.style.display = 'flex';
            } else {
                customDateRange.style.display = 'none';
            }
            
            // Update chart
            updateTrendsChart();
        }

        // Initialize the trends chart
        async function initializeTrendsChart() {
            // Load historical data
            await loadHistoricalData();
            
            // Create the chart
            const ctx = document.getElementById('price-trends-chart').getContext('2d');
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toFixed(3);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(3);
                                }
                            }
                        }
                    }
                }
            });
            
            // Initial chart update
            updateTrendsChart();
            
            // Set up date change listeners
            const startDate = document.getElementById('trends-start-date');
            const endDate = document.getElementById('trends-end-date');
            
            if (startDate && endDate) {
                startDate.addEventListener('change', updateTrendsChart);
                endDate.addEventListener('change', updateTrendsChart);
            }
        }

        // Load historical data from timestamped CSVs (with caching)
        async function loadHistoricalData() {
            // Return cached data if available
            if (historicalDataCache !== null) {
                console.log('Using cached historical data');
                filterHistoricalDataForCurrentStore();
                return;
            }
            
            // Prevent duplicate loads
            if (historicalDataLoading) {
                console.log('Historical data already loading...');
                return;
            }
            
            historicalDataLoading = true;
            
            try {
                // Load manifest to get list of historical files
                let csvFiles = ['master_price_data.csv'];
                
                try {
                    const manifestResponse = await fetch('manifest.json');
                    if (manifestResponse.ok) {
                        const manifest = await manifestResponse.json();
                        if (manifest.historical_files && Array.isArray(manifest.historical_files)) {
                            // Add all historical files from manifest
                            csvFiles = ['master_price_data.csv', ...manifest.historical_files];
                            console.log(`Loaded ${manifest.historical_files.length} historical files from manifest`);
                        }
                    }
                } catch (e) {
                    console.log('Could not load manifest.json, using current data only');
                }
                
                const allHistoricalData = [];
                
                // Use Promise.all to load files in parallel
                const loadPromises = csvFiles.map(async (filename) => {
                    try {
                        const response = await fetch(filename);
                        if (!response.ok) {
                            console.warn(`Could not load ${filename}: ${response.status}`);
                            return [];
                        }
                        
                        const csvText = await response.text();
                        const lines = csvText.split('\n');
                        const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, '').trim());
                        
                        // Extract timestamp from filename
                        let fileTimestamp;
                        const timestampMatch = filename.match(/(\d{8})_(\d{6})/);
                        if (timestampMatch) {
                            const dateStr = timestampMatch[1];
                            const timeStr = timestampMatch[2];
                            // Format: YYYYMMDD_HHMMSS
                            fileTimestamp = new Date(
                                `${dateStr.slice(0,4)}-${dateStr.slice(4,6)}-${dateStr.slice(6,8)}T${timeStr.slice(0,2)}:${timeStr.slice(2,4)}:${timeStr.slice(4,6)}`
                            );
                        } else {
                            fileTimestamp = new Date(); // Use current time for master file
                        }
                        
                        const fileData = [];
                        
                        // Parse CSV data (only necessary columns for performance)
                        for (let i = 1; i < lines.length; i++) {
                            if (lines[i].trim() === '') continue;
                            
                            const values = parseCSVLine(lines[i]);
                            const row = {
                                RR_Location: values[headers.indexOf('RR_Location')] || '',
                                Station_ID: values[headers.indexOf('Station_ID')] || '',
                                Station_Name: values[headers.indexOf('Station_Name')] || '',
                                Unleaded_Regular_Price: values[headers.indexOf('Unleaded_Regular_Price')] || '',
                                Unleaded_Plus_Price: values[headers.indexOf('Unleaded_Plus_Price')] || '',
                                Unleaded_Premium_Price: values[headers.indexOf('Unleaded_Premium_Price')] || '',
                                Diesel_Regular_Price: values[headers.indexOf('Diesel_Regular_Price')] || '',
                                _fileTimestamp: fileTimestamp
                            };
                            
                            fileData.push(row);
                        }
                        
                        return fileData;
                    } catch (err) {
                        console.warn(`Error loading ${filename}:`, err);
                        return [];
                    }
                });
                
                // Wait for all files to load
                const results = await Promise.all(loadPromises);
                results.forEach(fileData => {
                    allHistoricalData.push(...fileData);
                });
                
                // Cache the complete historical data
                historicalDataCache = allHistoricalData;
                
                console.log(`Loaded and cached ${historicalDataCache.length} historical data points`);
                
                // Filter for current store
                filterHistoricalDataForCurrentStore();
                
            } catch (error) {
                console.error('Error loading historical data:', error);
            } finally {
                historicalDataLoading = false;
            }
        }
        
        // Filter cached historical data for current store
        function filterHistoricalDataForCurrentStore() {
            if (!currentStore || !historicalDataCache) {
                currentStoreHistoricalData = [];
                return;
            }
            
            const storeName = currentStore.rr_store_data.name;
            currentStoreHistoricalData = historicalDataCache.filter(row => 
                row.RR_Location === storeName
            );
            
            console.log(`Filtered ${currentStoreHistoricalData.length} data points for current store`);
        }

        // Update the trends chart with current settings
        function updateTrendsChart() {
            if (!trendsChart || !currentStore) return;
            
            const fuelPriceColumn = {
                'Regular': 'Unleaded_Regular_Price',
                'Midgrade': 'Unleaded_Plus_Price',
                'Premium': 'Unleaded_Premium_Price',
                'Diesel': 'Diesel_Regular_Price'
            }[trendsFuelType];
            
            // Get the list of visible competitors for the current store
            const storeName = currentStore.rr_store_data.name;
            const allStations = masterData
                .filter(row => row.RR_Location === storeName)
                .sort((a, b) => parseFloat(a.Distance || 999) - parseFloat(b.Distance || 999));
            const competitors = allStations.filter(row => !row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            const visibleCompetitorIds = new Set();
            const visibleCompetitorNames = new Set();
            const visibleCompetitorKeys = new Set();

            // Get the IDs of visible competitors
            competitors.forEach((comp, idx) => {
                if (visibleCompetitors.has(idx)) {
                    visibleCompetitorIds.add(comp.Station_ID);
                    visibleCompetitorNames.add(normalizeStationName(comp.Station_Name));
                    // Create keys using both Station_ID and Name+Address for compatibility
                    visibleCompetitorKeys.add(comp.Station_ID);
                    const key = `${comp.Station_Name}|${comp.Station_Address}`;
                    visibleCompetitorKeys.add(key);
                }
            });

            // Determine time range
            let startDate = new Date();
            let endDate = new Date();

            if (trendsTimeFrame === 'Live') {
                startDate = new Date(endDate.getTime() - 24 * 60 * 60 * 1000); // 24 hours ago
            } else if (trendsTimeFrame === '7 Days') {
                startDate = new Date(endDate.getTime() - 7 * 24 * 60 * 60 * 1000); // 7 days ago
            } else if (trendsTimeFrame === 'Custom') {
                const startInput = document.getElementById('trends-start-date');
                const endInput = document.getElementById('trends-end-date');
                if (startInput && endInput && startInput.value && endInput.value) {
                    startDate = new Date(startInput.value);
                    endDate = new Date(endInput.value);
                    endDate.setHours(23, 59, 59); // End of day
                }
            }

            // Use cached store-specific data instead of filtering all historical data
            const filteredData = currentStoreHistoricalData.filter(row => {
                const rowDate = row._fileTimestamp;
                return rowDate >= startDate && rowDate <= endDate;
            });

            // Group data by timestamp first, then by station
            const dataByTimestamp = {};
            const allTimestamps = new Set();

            filteredData.forEach(row => {
                const station = row.Station_Name;
                const normalizedStation = normalizeStationName(station);
                const price = parseFloat(row[fuelPriceColumn]);
                const timestamp = row._fileTimestamp;
                
                // DEBUG - Check if Shell has address
                if (station.includes('SHELL SERVICE')) {
                    console.log('Shell row:', {
                        Station_Name: row.Station_Name,
                        Station_Address: row.Station_Address,
                        Station_ID: row.Station_ID
                    });
                }



                if (!station || isNaN(price) || price <= 0) return;
                
                // Check if this is Road Ranger or a selected competitor
                const isRoadRanger = station.toUpperCase().includes('ROAD RANGER');
                
                // Match by Station_ID if available, otherwise just Station_Name
                let competitorKey;
                if (row.Station_ID) {
                    competitorKey = row.Station_ID;
                } else {
                    competitorKey = row.Station_Name;
                }


                // DEBUG - Log first 5 competitor rows to see what keys we're checking
                if (!isRoadRanger && filteredData.indexOf(row) < 100) {
                    console.log('Checking competitor:', {
                        Station_Name: row.Station_Name,
                        Station_ID: row.Station_ID,
                        competitorKey: competitorKey,
                        isMatch: visibleCompetitorKeys.has(competitorKey)
                    });
                }

                const isSelectedCompetitor = visibleCompetitorKeys.has(competitorKey);
                
                if (!isRoadRanger && !isSelectedCompetitor) return;
                
                // Format timestamp as string
                const timeStr = timestamp.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true
                });
                
                allTimestamps.add(timeStr);
                
                if (!dataByTimestamp[timeStr]) {
                    dataByTimestamp[timeStr] = {
                        timestamp: timestamp,
                        stations: {}
                    };
                }
                
                // Use Station_Name for Road Ranger (no ID in historical data)
                // Use Station_ID for competitors (they have IDs)
                let stationKey;
                if (isRoadRanger) {
                    stationKey = row.Station_Name;
                } else if (row.Station_ID) {
                    stationKey = row.Station_ID;
                } else {
                    // Fallback
                    stationKey = row.Station_Name;
                }

                if (!dataByTimestamp[timeStr].stations[stationKey] || 
                    dataByTimestamp[timeStr].stations[stationKey].price < price) {
                    // For competitors with Station_ID, extract address from the ID (format: NAME|ADDRESS|CITY)
                    let displayName;
                    if (!isRoadRanger && row.Station_ID && row.Station_ID.includes('|')) {
                        const parts = row.Station_ID.split('|');
                        displayName = `${normalizeStationName(parts[0])} - ${parts[1]}`;
                    } else if (row.Station_Address) {
                        displayName = `${normalizeStationName(station)} - ${row.Station_Address}`;
                    } else {
                        displayName = normalizeStationName(station);
                    }
                    
                    dataByTimestamp[timeStr].stations[stationKey] = { 
                        price, 
                        timestamp,
                        displayName: displayName
                    };
                }
            });


            
            // Sort timestamps
            const sortedTimestamps = Array.from(allTimestamps).sort((a, b) => {
                const timeA = dataByTimestamp[a].timestamp;
                const timeB = dataByTimestamp[b].timestamp;
                return timeA - timeB;
            });
            
            // Collect all unique stations
            const uniqueStations = new Set();
            Object.values(dataByTimestamp).forEach(timeData => {
                Object.keys(timeData.stations).forEach(station => uniqueStations.add(station));
            });
            
            // DEBUG - Add here
            console.log('Unique stations found in historical data:', Array.from(uniqueStations));
            console.log('Total timestamps:', sortedTimestamps.length);
            console.log('Visible competitor keys:', Array.from(visibleCompetitorKeys));


            // Create datasets for chart
            const datasets = [];
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', 
                '#14b8a6', '#f97316', '#06b6d4', '#84cc16', '#f43f5e'
            ];
            let colorIndex = 0;
            
            // Separate Road Ranger data from competitors
            const roadRangerData = [];
            const competitorDatasets = new Map();
            
            // Process each unique station ID
            uniqueStations.forEach(stationId => {
                console.log('Processing station:', stationId); // ADD THIS
                const data = sortedTimestamps.map(timeStr => {
                    const timeData = dataByTimestamp[timeStr];
                    if (timeData.stations[stationId]) {
                        return timeData.stations[stationId].price;
                    }
                    return null;
                });
                
                // Get the display name from the first occurrence
                let displayName = stationId;
                for (const timeStr of sortedTimestamps) {
                    if (dataByTimestamp[timeStr].stations[stationId]) {
                        displayName = dataByTimestamp[timeStr].stations[stationId].displayName;
                        break;
                    }
                }
                console.log('Station:', stationId, '-> Display name:', displayName);
                
                const isRoadRanger = displayName.toUpperCase().includes('ROAD RANGER');
                
                if (isRoadRanger) {
                    // ... Road Ranger handling (same as before)
                    data.forEach((price, idx) => {
                        if (price !== null) {
                            roadRangerData[idx] = price;
                        }
                    });
                } else {
                    // Store competitor data with display name
                    competitorDatasets.set(displayName, data);
                }
            });
            
            // Create single Road Ranger dataset if we have data
            if (roadRangerData.some(price => price !== null)) {
                datasets.push({
                    label: 'Road Ranger',
                    data: roadRangerData,
                    borderColor: '#dc2626',
                    backgroundColor: '#dc2626',
                    borderWidth: 3,
                    pointRadius: 0,
                    tension: 0.1,
                    spanGaps: true
                });
            }
            
            // Create competitor datasets
            competitorDatasets.forEach((data, station) => {
                const color = colors[colorIndex % colors.length];
                datasets.push({
                    label: station,
                    data: data,
                    borderColor: color,
                    backgroundColor: color,
                    borderWidth: 2,
                    pointRadius: 0,
                    tension: 0.1,
                    spanGaps: true
                });
                colorIndex++;
            });
            
            // Update chart (use update instead of recreating)
            trendsChart.data.labels = sortedTimestamps;
            trendsChart.data.datasets = datasets;
            trendsChart.update('none'); // 'none' mode for faster updates without animations
        }

        // Toggle filter dropdown
        function toggleFilterDropdown() {
            const content = document.getElementById('filter-content');
            const toggle = document.getElementById('filter-toggle');
            
            content.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        // Toggle competitor visibility
        function toggleCompetitor(index) {
            if (visibleCompetitors.has(index)) {
                visibleCompetitors.delete(index);
            } else {
                visibleCompetitors.add(index);
            }
            
            // Save the updated selections
            if (currentStore) {
                const storeNumber = currentStore.rr_store.replace('Road Ranger #', '').split(' - ')[0];
                saveSelections(storeNumber, visibleCompetitors);
            }
            
            refreshPricingDisplay();
            updateTrendsChart(); // Update trends chart when competitors change
        }

        // Select all competitors
        function selectAllCompetitors() {
            const checkboxes = document.querySelectorAll('.competitor-checkbox-item input[type="checkbox"]');
            checkboxes.forEach((checkbox, idx) => {
                checkbox.checked = true;
                visibleCompetitors.add(idx);
            });
            
            // Save the updated selections
            if (currentStore) {
                const storeNumber = currentStore.rr_store.replace('Road Ranger #', '').split(' - ')[0];
                saveSelections(storeNumber, visibleCompetitors);
            }
            
            refreshPricingDisplay();
            updateTrendsChart();
        }

        // Deselect all competitors
        function deselectAllCompetitors() {
            const checkboxes = document.querySelectorAll('.competitor-checkbox-item input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            visibleCompetitors.clear();
            
            // Save the updated selections
            if (currentStore) {
                const storeNumber = currentStore.rr_store.replace('Road Ranger #', '').split(' - ')[0];
                saveSelections(storeNumber, visibleCompetitors);
            }
            
            refreshPricingDisplay();
            updateTrendsChart();
        }

        // Select top 10 closest competitors
        function selectTop10Competitors() {
            if (!currentStore) return;
            
            const storeNumber = currentStore.rr_store.replace('Road Ranger #', '').split(' - ')[0];
            
            // Clear all selections first
            visibleCompetitors.clear();
            
            // Competitors are already sorted by distance, so just select first 10 indices
            for (let i = 0; i < 10; i++) {
                visibleCompetitors.add(i);
            }
            
            // Update checkboxes
            const checkboxes = document.querySelectorAll('.competitor-checkbox-item input[type="checkbox"]');
            checkboxes.forEach((checkbox, idx) => {
                checkbox.checked = visibleCompetitors.has(idx);
            });
            
            // Save the updated selections
            saveSelections(storeNumber, visibleCompetitors);
            
            refreshPricingDisplay();
            updateTrendsChart();
        }

        // Reset to default selections (clears saved preferences)
        function resetToDefaults() {
            if (!currentStore) return;
            
            const storeNumber = currentStore.rr_store.replace('Road Ranger #', '').split(' - ')[0];
            const storeName = currentStore.rr_store_data.name;
            
            // Clear saved selections for this store
            try {
                const allSelections = loadSavedSelections();
                delete allSelections[storeNumber];
                localStorage.setItem('rrCompetitorSelections', JSON.stringify(allSelections));
            } catch (e) {
                console.warn('Error clearing saved selections:', e);
            }
            
            // Get competitors
            const allStations = masterData
                .filter(row => row.RR_Location === storeName)
                .sort((a, b) => parseFloat(a.Distance || 999) - parseFloat(b.Distance || 999));
            const competitors = allStations.filter(row => !row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            
            // Reset to defaults (custom defaults or top 10)
            visibleCompetitors = getSavedOrDefaultSelections(storeNumber, competitors);
            
            // Update checkboxes
            const checkboxes = document.querySelectorAll('.competitor-checkbox-item input[type="checkbox"]');
            checkboxes.forEach((checkbox, idx) => {
                checkbox.checked = visibleCompetitors.has(idx);
            });
            
            refreshPricingDisplay();
            updateTrendsChart();
        }

        // Refresh pricing display after filter changes
        function refreshPricingDisplay() {
            if (!currentStore) return;
            
            const storeNumber = currentStore.rr_store.replace('Road Ranger #', '').split(' - ')[0];
            const storeName = currentStore.rr_store_data.name;
            const allStations = masterData
                .filter(row => row.RR_Location === storeName)
                .sort((a, b) => parseFloat(a.Distance || 999) - parseFloat(b.Distance || 999));
            const rrStation = allStations.find(row => row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            const competitors = allStations.filter(row => !row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            
            // Update filter header count
            const filterHeader = document.querySelector('.filter-header span');
            if (filterHeader) {
                filterHeader.textContent = `Competitor Filter (${visibleCompetitors.size} of ${competitors.length} selected)`;
            }
            
            // Re-render the pricing table
            document.getElementById('pricing-table-container').innerHTML = 
                renderPricingTable(storeNumber, rrStation, competitors);
        }

        // Set up competitor search functionality
        function setupCompetitorSearch() {
            const searchInput = document.getElementById('competitor-search');
            if (!searchInput) return;
            
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const items = document.querySelectorAll('.competitor-checkbox-item');
                
                items.forEach(item => {
                    const name = item.querySelector('.competitor-checkbox-name').textContent.toLowerCase();
                    
                    if (name.includes(searchTerm)) {
                        item.classList.remove('hidden');
                    } else {
                        item.classList.add('hidden');
                    }
                });
            });
        }

        // Format price for display with timestamp and source indicator
        function formatPrice(price, timestamp, apiUpdated, ranking, showSource = true) {
            if (!price || price === '' || price === 'None' || price === 'null') {
                return '<span class="price-na">N/A</span>';
            }
            
            const numPrice = parseFloat(price);
            if (isNaN(numPrice)) {
                return '<span class="price-na">N/A</span>';
            }
            
            // Determine source (API or WEX)
            const isApiPrice = apiUpdated === 'Yes';
            const sourceLabel = isApiPrice ? 'API' : 'WEX';
            const sourceClass = isApiPrice ? '' : 'wex';
            
            let html = `<span class="price-value">$${numPrice.toFixed(3)}</span>`;
            if (showSource) {
                html += `<span class="price-source ${sourceClass}">${sourceLabel}</span>`;
            }
            
            // Add timestamp if available and valid
            if (timestamp && timestamp !== '' && timestamp !== 'None' && timestamp !== 'null') {
                let formattedTimestamp = null;
                
                // Check if it's a relative time string (Speedway format)
                if (timestamp.includes('ago') || timestamp.includes('hour') || timestamp.includes('minute') || timestamp.includes('day')) {
                    formattedTimestamp = timestamp;
                } else {
                    try {
                        // Try parsing Casey's format: "01/25/2026 16:59:13 PM"
                        let date = null;
                        
                        if (timestamp.includes('/') && (timestamp.includes('PM') || timestamp.includes('AM'))) {
                            // Casey's format: MM/DD/YYYY HH:MM:SS PM
                            const cleanTimestamp = timestamp.replace(' PM', '').replace(' AM', '');
                            date = new Date(cleanTimestamp);
                        } else {
                            // Standard ISO format
                            date = new Date(timestamp);
                        }
                        
                        // Check if date is valid
                        if (date && !isNaN(date.getTime())) {
                            const formattedDate = date.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                timeZone: 'America/Chicago'
                            });
                            const formattedTime = date.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true,
                                timeZone: 'America/Chicago'
                            });
                            formattedTimestamp = `${formattedDate} ${formattedTime}`;
                        }
                    } catch (e) {
                        console.warn('Invalid timestamp:', timestamp, e);
                    }
                }
                
                if (formattedTimestamp) {
                    html += `<span class="price-timestamp">${formattedTimestamp}</span>`;
                }
            }
            
            return html;
        }

        // Format price with difference indicator
        function formatPriceWithDiff(price, rrPrice, timestamp, apiUpdated, ranking) {
            if (!price || price === '' || price === 'None' || price === 'null') {
                return '<span class="price-na">N/A</span>';
            }
            
            const numPrice = parseFloat(price);
            if (isNaN(numPrice)) {
                return '<span class="price-na">N/A</span>';
            }
            
            let html = '';
            
            // Add price difference ABOVE if RR price is available
            if (rrPrice && rrPrice !== '' && rrPrice !== 'None' && rrPrice !== 'null') {
                const numRRPrice = parseFloat(rrPrice);
                if (!isNaN(numRRPrice)) {
                    const diff = numPrice - numRRPrice;
                    const absDiff = Math.abs(diff);
                    
                    if (absDiff > 0.001) {
                        let diffClass = '';
                        let diffText = '';
                        
                        if (diff > 0) {
                            // Competitor is more expensive (good for RR)
                            diffClass = 'cheaper';
                            diffText = `+$${absDiff.toFixed(3)}`;
                        } else {
                            // Competitor is cheaper (bad for RR)
                            diffClass = 'more-expensive';
                            diffText = `-$${absDiff.toFixed(3)}`;
                        }
                        
                        html += `<span class="price-diff ${diffClass}">${diffText}</span>`;
                    } else {
                        // Add empty space to maintain alignment when no difference
                        html += `<span class="price-diff" style="visibility: hidden;">+$0.000</span>`;
                    }
                } else {
                    // Add empty space to maintain alignment
                    html += `<span class="price-diff" style="visibility: hidden;">+$0.000</span>`;
                }
            } else {
                // Add empty space to maintain alignment
                html += `<span class="price-diff" style="visibility: hidden;">+$0.000</span>`;
            }
            
            // Add the actual price
            html += `<span class="price-value">$${numPrice.toFixed(3)}</span>`;
            
            // Add timestamp if available and valid
            if (timestamp && timestamp !== '' && timestamp !== 'None' && timestamp !== 'null') {
                let formattedTimestamp = null;
                
                // Check if it's a relative time string
                if (timestamp.includes('ago') || timestamp.includes('hour') || timestamp.includes('minute') || timestamp.includes('day')) {
                    formattedTimestamp = timestamp;
                } else {
                    try {
                        let date = null;
                        
                        if (timestamp.includes('/') && (timestamp.includes('PM') || timestamp.includes('AM'))) {
                            const cleanTimestamp = timestamp.replace(' PM', '').replace(' AM', '');
                            date = new Date(cleanTimestamp);
                        } else {
                            date = new Date(timestamp);
                        }
                        
                        if (date && !isNaN(date.getTime())) {
                            const formattedDate = date.toLocaleDateString('en-US', { 
                                month: 'short', 
                                day: 'numeric',
                                timeZone: 'America/Chicago'
                            });
                            const formattedTime = date.toLocaleTimeString('en-US', { 
                                hour: 'numeric', 
                                minute: '2-digit',
                                hour12: true,
                                timeZone: 'America/Chicago'
                            });
                            formattedTimestamp = `${formattedDate} ${formattedTime}`;
                        }
                    } catch (e) {
                        console.warn('Invalid timestamp:', timestamp, e);
                    }
                }
                
                if (formattedTimestamp) {
                    html += `<span class="price-timestamp">${formattedTimestamp}</span>`;
                }
            }
            
            return html;
        }

        // Export to CSV
        function exportToCSV() {
            if (!currentStore) return;
            
            const storeNumber = currentStore.rr_store.replace('Road Ranger #', '').split(' - ')[0];
            const storeName = currentStore.rr_store_data.name;
            const allStations = masterData.filter(row => row.RR_Location === storeName);
            const rrStation = allStations.find(row => row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            const competitors = allStations.filter(row => !row.Station_Name.toUpperCase().includes('ROAD RANGER'));
            const visibleComps = competitors.filter((_, idx) => visibleCompetitors.has(idx));
            
            // Build CSV content
            let csv = 'Station Name,Distance (mi),Unleaded Regular,Unleaded Plus,Unleaded Premium,Diesel Regular\n';
            
            // Add RR row
            if (rrStation) {
                csv += `"Road Ranger #${storeNumber}",0,`;
                csv += `${rrStation.Unleaded_Regular_Price || 'N/A'},`;
                csv += `${rrStation.Unleaded_Plus_Price || 'N/A'},`;
                csv += `${rrStation.Unleaded_Premium_Price || 'N/A'},`;
                csv += `${rrStation.Diesel_Regular_Price || 'N/A'}\n`;
            }
            
            // Add competitor rows
            visibleComps.forEach(comp => {
                const distance = parseFloat(comp.Distance || 0).toFixed(1);
                csv += `"${normalizeStationName(comp.Station_Name)}",${distance},`;
                csv += `${comp.Unleaded_Regular_Price || 'N/A'},`;
                csv += `${comp.Unleaded_Plus_Price || 'N/A'},`;
                csv += `${comp.Unleaded_Premium_Price || 'N/A'},`;
                csv += `${comp.Diesel_Regular_Price || 'N/A'}\n`;
            });
            
            // Download the CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RoadRanger_${storeNumber}_Pricing_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }


// ===== SETTINGS MODAL FUNCTIONS =====

// Open settings modal
function openSettingsModal() {
    const modal = document.getElementById('settings-modal-overlay');
    modal.classList.add('visible');
    populateStoreSettingsList();
    setupModalStoreSearch();
}

// Close settings modal
function closeSettingsModal() {
    const modal = document.getElementById('settings-modal-overlay');
    modal.classList.remove('visible');
}

// Close modal when clicking overlay
function closeSettingsModalOnOverlayClick(event) {
    if (event.target.id === 'settings-modal-overlay') {
        closeSettingsModal();
    }
}

// Save settings and close modal
function saveSettingsAndClose() {
    saveStoreAlertSettings();
    updateAlerts();
    closeSettingsModal();
}

// Populate store settings list
function populateStoreSettingsList() {
    const container = document.getElementById('store-settings-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    rrData.forEach((location, index) => {
        const storeNumber = location.rr_store.replace('Road Ranger #', '').split(' - ')[0];
        const storeName = location.rr_store_data.name;
        const storeCity = location.rr_store.split(' - ')[1] || '';
        
        // Initialize rules for this store if not exists
        if (!storeAlertSettings[storeNumber]) {
            storeAlertSettings[storeNumber] = { rules: [] };
        }
        if (!storeAlertSettings[storeNumber].rules) {
            storeAlertSettings[storeNumber].rules = [];
        }
        
        // Get competitors for this store from CSV
        const allStations = masterData
            .filter(row => row.RR_Location === storeName)
            .sort((a, b) => parseFloat(a.Distance || 999) - parseFloat(b.Distance || 999));
        const competitors = allStations
            .filter(row => !row.Station_Name.toUpperCase().includes('ROAD RANGER'))
            .map(row => row.Station_Name);
        
        const card = document.createElement('div');
        card.className = 'store-settings-card';
        card.dataset.storeNumber = storeNumber;
        card.dataset.storeCity = storeCity;
        
        let cardHTML = `
            <div class="store-settings-header" onclick="toggleStoreSettingsCard(this)">
                <div class="store-settings-info">
                    <div class="store-settings-number">#${storeNumber}</div>
                    <div class="store-settings-location">${storeCity}</div>
                </div>
                <span class="store-settings-toggle">‚ñº</span>
            </div>
            <div class="store-settings-body">
                <!-- Rule Creation Form -->
                <div class="rule-creation-form">
                    <div class="rule-form-row">
                        <div style="position: relative; display: inline-block;">
                            <input type="text" 
                                class="rule-select" 
                                id="competitor-search-${storeNumber}" 
                                placeholder="Search competitor..."
                                autocomplete="off"
                                style="width: 250px;"
                                onfocus="showCompetitorDropdown('${storeNumber}')"
                                oninput="filterCompetitors('${storeNumber}')">
                            <div id="competitor-dropdown-${storeNumber}" 
                                class="competitor-dropdown-menu"
                                style="display: none; position: absolute; top: 100%; left: 0; width: 250px; max-height: 400px; overflow-y: auto; background: white; border: 2px solid #e0e0e0; border-radius: 6px; z-index: 9999; margin-top: 2px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                ${competitors.map(comp => `
                                    <div class="competitor-option" 
                                        data-value="${comp}"
                                        onclick="selectCompetitor('${storeNumber}', '${comp.replace(/'/g, "\\'")}')"
                                        style="padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;"
                                        onmouseover="this.style.background='#f8f9fa'"
                                        onmouseout="this.style.background='white'">
                                        ${comp}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <select class="rule-select" id="fueltype-select-${storeNumber}">
                            <option value="Regular">Regular</option>
                            <option value="Mid-Grade">Mid-Grade</option>
                            <option value="Premium">Premium</option>
                            <option value="Diesel">Diesel</option>
                        </select>
                        <select class="rule-select" id="direction-select-${storeNumber}">
                            <option value="Higher">Higher</option>
                            <option value="Lower">Lower</option>
                        </select>
                        <input type="number" 
                            class="rule-input" 
                            id="cents-input-${storeNumber}" 
                            placeholder="0" 
                            min="0" 
                            step="1">
                        <span class="rule-cents-label">cents</span>
                        <button class="rule-save-btn" onclick="saveNewRule('${storeNumber}', '${storeCity}')">Save</button>
                    </div>
                </div>
                
                <!-- Rules Display -->
                <div class="rules-display-section">
                    <div class="rules-display-header">Rules set for this store:</div>
                    <div class="rules-list" id="rules-list-${storeNumber}">
                        ${generateRulesHTML(storeNumber, storeCity)}
                    </div>
                </div>
            </div>
        `;
        
        card.innerHTML = cardHTML;
        container.appendChild(card);
    });
}

// Generate HTML for rules list
function generateRulesHTML(storeNumber, storeCity) {
    const rules = storeAlertSettings[storeNumber]?.rules || [];
    
    if (rules.length === 0) {
        return '<div class="no-rules-message">No rules set for this store yet.</div>';
    }
    
    return rules.map((rule, index) => `
        <div class="rule-item">
            <span class="rule-item-text">
                ${rule.competitor} - ${rule.fuelType} - ${rule.direction} - ${rule.cents} cent(s) - ${storeCity}
            </span>
            <button class="rule-delete-btn" onclick="deleteRule('${storeNumber}', ${index})">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
        </div>
    `).join('');
}

// Save new rule
function saveNewRule(storeNumber, storeCity) {
    const competitorInput = document.getElementById(`competitor-search-${storeNumber}`);
    const competitor = competitorInput.dataset.selectedValue || competitorInput.value;
    const fuelType = document.getElementById(`fueltype-select-${storeNumber}`).value;
    const direction = document.getElementById(`direction-select-${storeNumber}`).value;
    const cents = document.getElementById(`cents-input-${storeNumber}`).value;
    
    if (!competitor) {
        alert('Please select a competitor');
        return;
    }
    
    if (!cents || cents <= 0) {
        alert('Please enter a valid number of cents');
        return;
    }
    
    // Initialize rules array if it doesn't exist
    if (!storeAlertSettings[storeNumber]) {
        storeAlertSettings[storeNumber] = { rules: [] };
    }
    if (!storeAlertSettings[storeNumber].rules) {
        storeAlertSettings[storeNumber].rules = [];
    }
    
    // Add the new rule
    storeAlertSettings[storeNumber].rules.push({
        competitor: competitor,
        fuelType: fuelType,
        direction: direction,
        cents: parseFloat(cents)
    });
    
    // Reset form
    document.getElementById(`fueltype-select-${storeNumber}`).value = 'Regular';
    document.getElementById(`direction-select-${storeNumber}`).value = 'Higher';
    document.getElementById(`cents-input-${storeNumber}`).value = '';
    competitorInput.value = '';
    delete competitorInput.dataset.selectedValue;
    
    // Refresh the rules list
    const rulesList = document.getElementById(`rules-list-${storeNumber}`);
    rulesList.innerHTML = generateRulesHTML(storeNumber, storeCity);
}

// Delete a rule
function deleteRule(storeNumber, ruleIndex) {
    if (!storeAlertSettings[storeNumber]?.rules) return;
    
    storeAlertSettings[storeNumber].rules.splice(ruleIndex, 1);
    
    // Refresh the rules list
    const storeCity = document.querySelector(`[data-store-number="${storeNumber}"]`)?.dataset.storeCity || '';
    const rulesList = document.getElementById(`rules-list-${storeNumber}`);
    rulesList.innerHTML = generateRulesHTML(storeNumber, storeCity);
}

// Show competitor dropdown
function showCompetitorDropdown(storeNumber) {
    const dropdown = document.getElementById(`competitor-dropdown-${storeNumber}`);
    if (dropdown) {
        dropdown.style.display = 'block';
    }
}

// Hide competitor dropdown when clicking outside
document.addEventListener('click', function(e) {
    document.querySelectorAll('[id^="competitor-dropdown-"]').forEach(dropdown => {
        if (!dropdown.parentElement.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
});

// Filter competitors based on search
function filterCompetitors(storeNumber) {
    const searchInput = document.getElementById(`competitor-search-${storeNumber}`);
    const dropdown = document.getElementById(`competitor-dropdown-${storeNumber}`);
    const searchTerm = searchInput.value.toLowerCase();
    
    const options = dropdown.querySelectorAll('.competitor-option');
    let visibleCount = 0;
    
    options.forEach(option => {
        const text = option.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            option.style.display = 'block';
            visibleCount++;
        } else {
            option.style.display = 'none';
        }
    });
    
    dropdown.style.display = visibleCount > 0 ? 'block' : 'none';
}

// Select a competitor from dropdown
function selectCompetitor(storeNumber, competitor) {
    const searchInput = document.getElementById(`competitor-search-${storeNumber}`);
    const dropdown = document.getElementById(`competitor-dropdown-${storeNumber}`);
    
    searchInput.value = competitor;
    searchInput.dataset.selectedValue = competitor;
    dropdown.style.display = 'none';
}



// Toggle store settings card
function toggleStoreSettingsCard(header) {
    const card = header.closest('.store-settings-card');
    const body = card.querySelector('.store-settings-body');
    const toggle = card.querySelector('.store-settings-toggle');
    
    body.classList.toggle('expanded');
    toggle.classList.toggle('expanded');
}

// Setup modal store search
function setupModalStoreSearch() {
    const searchInput = document.getElementById('modal-store-search');
    if (!searchInput) return;
    
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.store-settings-card');
        
        cards.forEach(card => {
            const storeNumber = card.dataset.storeNumber || '';
            const storeCity = card.dataset.storeCity || '';
            
            if (storeNumber.includes(searchTerm) || storeCity.toLowerCase().includes(searchTerm)) {
                card.classList.remove('hidden');
            } else {
                card.classList.add('hidden');
            }
        });
    });
}


        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', loadData);
    </script>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal-overlay" onclick="closeSettingsModalOnOverlayClick(event)">
        <div class="settings-modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">Alert Settings by Store</h2>
                <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
            </div>
            <div class="modal-body">
                <input type="text" class="modal-search" id="modal-store-search" placeholder="Search stores..." />
                <div class="store-settings-list" id="store-settings-list">
                    <!-- Store settings will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="saveSettingsAndClose()">Save Settings</button>
            </div>
        </div>
    </div>

</body>
</html>
